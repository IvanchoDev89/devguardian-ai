"""
Tests for Vulnerability Scanner Module
"""

import pytest
from app.scanners.vulnerability_scanner import (
    VulnerabilityScanner,
    create_scanner,
    Severity,
    Vulnerability
)


class TestVulnerabilityScanner:
    """Test suite for VulnerabilityScanner"""

    def setup_method(self):
        """Setup for each test"""
        self.scanner = create_scanner()

    def test_empty_code_returns_empty_result(self):
        """Test that empty code returns empty result"""
        result = self.scanner.analyze("", "python")
        assert result["total_vulnerabilities"] == 0
        assert result["score"] == 100

    def test_clean_code_returns_high_score(self):
        """Test that clean code returns high security score"""
        code = """
def hello_world():
    print("Hello, World!")
    return True

class Calculator:
    def add(self, a, b):
        return a + b
"""
        result = self.scanner.analyze(code, "python")
        assert result["total_vulnerabilities"] == 0
        assert result["score"] == 100

    def test_sql_injection_detection(self):
        """Test SQL injection detection"""
        code = """
def get_user(user_id):
    query = f"SELECT * FROM users WHERE id = {user_id}"
    cursor.execute(query)
"""
        result = self.scanner.analyze(code, "python")
        assert result["total_vulnerabilities"] > 0

    def test_hardcoded_password_detection(self):
        """Test hardcoded password detection"""
        code = """
DATABASE_PASSWORD = "mysecretpassword123"
API_KEY = "sk-1234567890abcdef"
"""
        result = self.scanner.analyze(code, "python")
        assert result["total_vulnerabilities"] >= 2
        types = [v["vulnerability_type"] for v in result["vulnerabilities"]]
        assert "Hardcoded Password" in types or "Hardcoded API Key" in types

    def test_xss_detection(self):
        """Test XSS vulnerability detection"""
        code = """
function displayUserInput(userInput) {
    document.getElementById('output').innerHTML = userInput;
}
"""
        result = self.scanner.analyze(code, "javascript")
        assert result["total_vulnerabilities"] > 0

    def test_eval_detection(self):
        """Test eval usage detection"""
        code = """
user_input = eval(user_expression)
"""
        result = self.scanner.analyze(code, "python")
        assert result["total_vulnerabilities"] > 0
        assert any(v["vulnerability_type"] == "Eval Usage" for v in result["vulnerabilities"])

    def test_weak_crypto_md5_detection(self):
        """Test weak cryptography detection (MD5)"""
        code = """
import hashlib
password_hash = hashlib.md5(password.encode()).hexdigest()
"""
        result = self.scanner.analyze(code, "python")
        assert result["total_vulnerabilities"] > 0
        assert any(v["vulnerability_type"] == "Weak Cryptography - MD5" for v in result["vulnerabilities"])

    def test_command_injection_detection(self):
        """Test command injection detection"""
        code = """
import os
os.system("ping " + hostname)
"""
        result = self.scanner.analyze(code, "python")
        assert result["total_vulnerabilities"] > 0

    def test_code_length_validation(self):
        """Test that code exceeding max length raises error"""
        large_code = "x" * (11 * 1024)  # 11KB > 10KB limit
        with pytest.raises(ValueError) as exc_info:
            self.scanner.analyze(large_code, "python")
        assert "exceeds maximum length" in str(exc_info.value)

    def test_unsupported_language_defaults_to_python(self):
        """Test that unsupported language defaults to python"""
        code = "password = 'test123'"
        result = self.scanner.analyze(code, "unsupported_language")
        assert result["language"] == "python"

    def test_security_score_calculation(self):
        """Test security score calculation with hardcoded password"""
        critical_code = "password = 'test123'"
        result = self.scanner.analyze(critical_code, "python")
        assert result["score"] < 100

    def test_multiple_vulnerabilities(self):
        """Test detection of multiple vulnerabilities"""
        code = """
password = "hardcoded123"
API_KEY = "sk_test_1234567890abcdef"
eval("dangerous_code")
"""
        result = self.scanner.analyze(code, "python")
        assert result["total_vulnerabilities"] >= 2

    def test_vulnerability_fields(self):
        """Test that vulnerability contains all required fields"""
        code = "password = 'secret'"
        result = self.scanner.analyze(code, "python")
        if result["vulnerabilities"]:
            vuln = result["vulnerabilities"][0]
            assert "line_number" in vuln
            assert "vulnerability_type" in vuln
            assert "severity" in vuln
            assert "description" in vuln
            assert "cwe_id" in vuln or vuln["cwe_id"] is None


class TestSeverityEnum:
    """Test Severity enum"""

    def test_severity_values(self):
        """Test severity enum values"""
        assert Severity.CRITICAL.value == "critical"
        assert Severity.HIGH.value == "high"
        assert Severity.MEDIUM.value == "medium"
        assert Severity.LOW.value == "low"
        assert Severity.INFO.value == "info"
