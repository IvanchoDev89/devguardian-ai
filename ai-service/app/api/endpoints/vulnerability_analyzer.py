"""
Vulnerability Analysis API - MVP Version
POST /api/v1/analyze-code - Analyze code for security vulnerabilities
GET /api/v1/health - Health check endpoint
"""

from fastapi import APIRouter, HTTPException, status, Request
from fastapi.responses import JSONResponse
from pydantic import BaseModel, Field, field_validator
from typing import List, Optional, Dict, Any
import logging
from datetime import datetime
import hashlib
import json

from app.scanners.vulnerability_scanner import (
    VulnerabilityScanner,
    create_scanner,
    Severity
)

# Configure logging
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

router = APIRouter(prefix="/api/v1", tags=["vulnerability-scanner"])

# Initialize scanner
scanner = create_scanner()

# In-memory audit log (use Redis/database in production)
audit_log: List[Dict[str, Any]] = []
MAX_AUDIT_ENTRIES = 1000


def log_audit_event(event_type: str, client_ip: str, data: Dict[str, Any]):
    """Log audit event for security tracking"""
    global audit_log
    
    entry = {
        "timestamp": datetime.now().isoformat(),
        "event_type": event_type,
        "client_ip": client_ip,
        "data": data
    }
    
    audit_log.append(entry)
    
    # Keep only last MAX_AUDIT_ENTRIES
    if len(audit_log) > MAX_AUDIT_ENTRIES:
        audit_log = audit_log[-MAX_AUDIT_ENTRIES:]
    
    logger.info(f"AUDIT: {event_type} from {client_ip}")


class AnalyzeCodeRequest(BaseModel):
    """Request model for code analysis"""
    code: str = Field(..., min_length=1, max_length=10240, description="Source code to analyze")
    language: str = Field(default="python", description="Programming language")
    
    @field_validator('language')
    @classmethod
    def validate_language(cls, v: str) -> str:
        supported = ["python", "javascript", "typescript", "java", "csharp", "php", "ruby", "go", "rust", "c", "cpp"]
        v_lower = v.lower()
        if v_lower not in supported:
            raise ValueError(f"Language must be one of: {', '.join(supported)}")
        return v_lower
    
    @field_validator('code')
    @classmethod
    def validate_code(cls, v: str) -> str:
        if not v or not v.strip():
            raise ValueError("Code cannot be empty")
        return v


class VulnerabilityResult(BaseModel):
    """Single vulnerability result"""
    line_number: int
    line_content: str
    vulnerability_type: str
    severity: str
    description: str
    match: str
    cwe_id: Optional[str] = None
    owasp_category: Optional[str] = None


class AnalyzeCodeResponse(BaseModel):
    """Response model for code analysis"""
    vulnerabilities: List[Dict[str, Any]]
    summary: str
    score: int = Field(..., ge=0, le=100)
    total_vulnerabilities: int
    language: str
    scan_id: str
    timestamp: str


class HealthResponse(BaseModel):
    """Health check response"""
    status: str
    timestamp: str
    service: str = "DevGuardian Vulnerability Scanner"
    version: str = "1.0.0"


@router.post("/analyze-code", response_model=AnalyzeCodeResponse)
async def analyze_code(request: AnalyzeCodeRequest, http_request: Request) -> AnalyzeCodeResponse:
    """
    Analyze code for security vulnerabilities
    
    - **code**: Source code to analyze (max 10KB)
    - **language**: Programming language (python, javascript, etc.)
    
    Returns list of vulnerabilities with severity levels and security score (0-100)
    """
    # Get client IP for audit
    client_ip = http_request.headers.get("x-forwarded-for", "unknown")
    if "," in client_ip:
        client_ip = client_ip.split(",")[0].strip()
    
    # Log the scan request
    log_audit_event(
        "scan_request",
        client_ip,
        {
            "language": request.language,
            "code_length": len(request.code),
            "code_hash": hashlib.sha256(request.code.encode()).hexdigest()[:16]
        }
    )
    
    logger.info(f"Analysis request received for language: {request.language}")
    
    try:
        # Log request (without sensitive data)
        code_hash = hashlib.sha256(request.code.encode()).hexdigest()[:16]
        logger.info(f"Code hash: {code_hash}, Length: {len(request.code)}")
        
        # Run analysis
        result = scanner.analyze(request.code, request.language)
        
        # Add scan ID
        scan_id = hashlib.sha256(
            f"{request.code}{datetime.now().isoformat()}".encode()
        ).hexdigest()[:16]
        
        result["scan_id"] = scan_id
        result["timestamp"] = datetime.now().isoformat()
        
        # Log scan completion
        log_audit_event(
            "scan_completed",
            client_ip,
            {
                "scan_id": scan_id,
                "vulnerabilities_found": result["total_vulnerabilities"],
                "score": result["score"]
            }
        )
        
        logger.info(f"Scan {scan_id} completed: {result['total_vulnerabilities']} vulnerabilities, score: {result['score']}")
        
        return AnalyzeCodeResponse(**result)
        
    except ValueError as e:
        logger.warning(f"Validation error: {str(e)}")
        log_audit_event(
            "scan_error",
            client_ip,
            {"error": str(e)}
        )
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail=str(e)
        )
    except Exception as e:
        logger.error(f"Analysis error: {str(e)}", exc_info=True)
        log_audit_event(
            "scan_error",
            client_ip,
            {"error": "internal_error"}
        )
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail="Internal server error during analysis"
        )


@router.get("/health", response_model=HealthResponse)
async def health_check() -> HealthResponse:
    """
    Health check endpoint
    
    Returns service status and basic information
    """
    return HealthResponse(
        status="ok",
        timestamp=datetime.now().isoformat(),
        service="DevGuardian Vulnerability Scanner",
        version="1.0.0"
    )


@router.get("/languages")
async def get_supported_languages() -> Dict[str, List[str]]:
    """Get list of supported programming languages"""
    return {
        "supported_languages": VulnerabilityScanner.SUPPORTED_LANGUAGES
    }


@router.get("/audit/logs")
async def get_audit_logs(limit: int = 100) -> Dict[str, Any]:
    """
    Get audit logs (admin endpoint)
    
    Returns recent scan events for security monitoring
    """
    return {
        "audit_logs": audit_log[-limit:],
        "total_entries": len(audit_log)
    }
