"""
Vulnerability Scanner Module - MVP Version
Basic regex-based security scanner for code analysis
Supports: SQL Injection, XSS, Hardcoded Credentials, Weak Crypto
"""

import re
from dataclasses import dataclass
from enum import Enum
from typing import List, Optional
import hashlib


class Severity(Enum):
    CRITICAL = "critical"
    HIGH = "high"
    MEDIUM = "medium"
    LOW = "low"
    INFO = "info"


@dataclass
class Vulnerability:
    """Represents a single vulnerability finding"""
    line_number: int
    line_content: str
    vulnerability_type: str
    severity: Severity
    description: str
    match: str
    cwe_id: Optional[str] = None
    owasp_category: Optional[str] = None


# Vulnerability patterns with metadata
VULNERABILITY_PATTERNS = [
    {
        "name": "SQL Injection",
        "pattern": r"(execute|exec|executemany|cursor\.execute)\s*\(\s*['\"].*?%s.*?['\"]",
        "severity": Severity.CRITICAL,
        "cwe": "CWE-89",
        "owasp": "A03:2021-Injection",
        "description": "Potential SQL injection vulnerability. Use parameterized queries instead."
    },
    {
        "name": "SQL Injection - String Concatenation",
        "pattern": r"(f[\"'].*?SELECT.*?\{.*?\}[\"']|[\"'].*?\+\s*.*?[\"'])",
        "severity": Severity.CRITICAL,
        "cwe": "CWE-89",
        "owasp": "A03:2021-Injection",
        "description": "SQL query built using string interpolation. Use parameterized queries."
    },
    {
        "name": "Hardcoded Password",
        "pattern": r"(password|passwd|pwd)\s*=\s*['\"][^'\"]{4,}['\"]",
        "severity": Severity.CRITICAL,
        "cwe": "CWE-259",
        "owasp": "A02:2021-Cryptographic Failures",
        "description": "Hardcoded password detected. Use environment variables or secure vaults."
    },
    {
        "name": "Hardcoded API Key",
        "pattern": r"(api[_-]?key|apikey)\s*=\s*['\"][A-Za-z0-9_\-]{16,}['\"]",
        "severity": Severity.CRITICAL,
        "cwe": "CWE-798",
        "owasp": "A02:2021-Cryptographic Failures",
        "description": "Hardcoded API key detected. Use environment variables."
    },
    {
        "name": "Hardcoded Secret",
        "pattern": r"(secret|token|auth)[_-]?(key|token)?\s*=\s*['\"][^'\"]{8,}['\"]",
        "severity": Severity.CRITICAL,
        "cwe": "CWE-798",
        "owasp": "A02:2021-Cryptographic Failures",
        "description": "Hardcoded secret detected. Use environment variables or secure vaults."
    },
    {
        "name": "XSS - Dangerous HTML Setting",
        "pattern": r"(\.innerHTML|\.outerHTML|insertAdjacentHTML)\s*=",
        "severity": Severity.HIGH,
        "cwe": "CWE-79",
        "owasp": "A03:2021-Injection",
        "description": "Direct HTML manipulation can lead to XSS. Use textContent or sanitize input."
    },
    {
        "name": "XSS - Document Write",
        "pattern": r"document\.write\s*\(",
        "severity": Severity.HIGH,
        "cwe": "CWE-79",
        "owasp": "A03:2021-Injection",
        "description": "document.write can lead to XSS vulnerabilities."
    },
    {
        "name": "Eval Usage",
        "pattern": r"\beval\s*\(",
        "severity": Severity.HIGH,
        "cwe": "CWE-95",
        "owasp": "A03:2021-Injection",
        "description": "eval() is dangerous and can lead to code injection."
    },
    {
        "name": "Weak Cryptography - MD5",
        "pattern": r"(hashlib\.md5|crypto\.createHash\(['\"]md5['\"])",
        "severity": Severity.MEDIUM,
        "cwe": "CWE-327",
        "owasp": "A02:2021-Cryptographic Failures",
        "description": "MD5 is cryptographically broken. Use SHA-256 or stronger."
    },
    {
        "name": "Weak Cryptography - SHA1",
        "pattern": r"(hashlib\.sha1|crypto\.createHash\(['\"]sha1['\"])",
        "severity": Severity.MEDIUM,
        "cwe": "CWE-327",
        "owasp": "A02:2021-Cryptographic Failures",
        "description": "SHA1 is considered weak. Use SHA-256 or stronger."
    },
    {
        "name": "Insecure Random",
        "pattern": r"random\.random\(\)|Math\.random\(\)",
        "severity": Severity.MEDIUM,
        "cwe": "CWE-338",
        "owasp": "A02:2021-Cryptographic Failures",
        "description": "Weak random number generator. Use crypto.getRandomValues() or secrets module."
    },
    {
        "name": "Hardcoded IP Address",
        "pattern": r"\b(?:[0-9]{1,3}\.){3}[0-9]{1,3}\b",
        "severity": Severity.LOW,
        "cwe": "CWE-798",
        "owasp": "A02:2021-Cryptographic Failures",
        "description": "Hardcoded IP address detected. Use configuration instead."
    },
    {
        "name": "Debug Mode Enabled",
        "pattern": r"(DEBUG\s*=\s*True|debug:\s*true)",
        "severity": Severity.MEDIUM,
        "cwe": "CWE-11",
        "owasp": "A05:2021-Security Misconfiguration",
        "description": "Debug mode should be disabled in production."
    },
    {
        "name": "Command Injection",
        "pattern": r"(os\.system|os\.popen|subprocess\.call|subprocess\.run)\s*\(\s*.*?['\"]",
        "severity": Severity.CRITICAL,
        "cwe": "CWE-78",
        "owasp": "A03:2021-Injection",
        "description": "Potential command injection. Sanitize all inputs or use shell=False."
    },
    {
        "name": "Path Traversal",
        "pattern": r"(open|read|file)\s*\(\s*.*?\+.*?(path|file|dir)",
        "severity": Severity.HIGH,
        "cwe": "CWE-22",
        "owasp": "A01:2021-Broken Access Control",
        "description": "Potential path traversal vulnerability. Validate and sanitize file paths."
    },
    {
        "name": "Insecure Deserialization",
        "pattern": r"(pickle\.load|yaml\.load|json\.loads)\s*\(",
        "severity": Severity.HIGH,
        "cwe": "CWE-502",
        "owasp": "A08:2021-Software and Data Integrity Failures",
        "description": "Insecure deserialization can lead to remote code execution."
    },
    {
        "name": "Unvalidated Redirect",
        "pattern": r"(redirect|location\.href)\s*=\s*.*?\+",
        "severity": Severity.MEDIUM,
        "cwe": "CWE-601",
        "owasp": "A10:2021-Server-Side Request Forgery",
        "description": "Potential unvalidated redirect. Validate all redirect destinations."
    },
    {
        "name": "Sensitive Data Exposure",
        "pattern": r"(console\.log|print)\s*\(.*?(password|secret|token|key).*?\)",
        "severity": Severity.MEDIUM,
        "cwe": "CWE-532",
        "owasp": "A01:2021-Broken Access Control",
        "description": "Sensitive data being logged. Avoid logging secrets."
    }
]


class VulnerabilityScanner:
    """Main scanner class for analyzing code"""

    MAX_CODE_LENGTH = 10 * 1024  # 10KB
    SUPPORTED_LANGUAGES = [
        "python", "javascript", "typescript", "java", "csharp",
        "php", "ruby", "go", "rust", "c", "cpp"
    ]

    def __init__(self):
        self.patterns = VULNERABILITY_PATTERNS

    def analyze(self, code: str, language: str = "python") -> dict:
        """
        Analyze code for vulnerabilities
        
        Args:
            code: Source code to analyze
            language: Programming language (for future extensibility)
            
        Returns:
            Dictionary with vulnerabilities and summary
        """
        # Validate input
        if not code or not code.strip():
            return self._empty_result()
        
        if len(code) > self.MAX_CODE_LENGTH:
            raise ValueError(f"Code exceeds maximum length of {self.MAX_CODE_LENGTH} bytes")
        
        if language.lower() not in self.SUPPORTED_LANGUAGES:
            language = "python"  # Default fallback

        vulnerabilities = self._scan_code(code)
        
        # Calculate security score (0-100, higher is better)
        score = self._calculate_score(vulnerabilities)
        
        # Generate summary
        summary = self._generate_summary(vulnerabilities, score)

        return {
            "vulnerabilities": [v.__dict__ for v in vulnerabilities],
            "summary": summary,
            "score": score,
            "total_vulnerabilities": len(vulnerabilities),
            "language": language
        }

    def _scan_code(self, code: str) -> List[Vulnerability]:
        """Scan code line by line for vulnerabilities"""
        vulnerabilities = []
        lines = code.split('\n')

        for line_num, line in enumerate(lines, start=1):
            for pattern_info in self.patterns:
                try:
                    if re.search(pattern_info["pattern"], line, re.IGNORECASE):
                        match = re.search(pattern_info["pattern"], line, re.IGNORECASE)
                        vulnerability = Vulnerability(
                            line_number=line_num,
                            line_content=line.strip()[:100],  # Truncate long lines
                            vulnerability_type=pattern_info["name"],
                            severity=pattern_info["severity"],
                            description=pattern_info["description"],
                            match=match.group(0) if match else "",
                            cwe_id=pattern_info.get("cwe"),
                            owasp_category=pattern_info.get("owasp")
                        )
                        vulnerabilities.append(vulnerability)
                except re.error:
                    continue  # Skip invalid patterns

        return vulnerabilities

    def _calculate_score(self, vulnerabilities: List[Vulnerability]) -> int:
        """Calculate security score based on vulnerabilities found"""
        if not vulnerabilities:
            return 100

        # Deduct points based on severity
        deductions = {
            Severity.CRITICAL: 20,
            Severity.HIGH: 10,
            Severity.MEDIUM: 5,
            Severity.LOW: 2,
            Severity.INFO: 1
        }

        total_deduction = sum(deductions.get(v.severity, 0) for v in vulnerabilities)
        score = max(0, 100 - total_deduction)

        return score

    def _generate_summary(self, vulnerabilities: List[Vulnerability], score: int) -> str:
        """Generate human-readable summary"""
        if not vulnerabilities:
            return "No vulnerabilities detected. Your code looks secure!"

        by_severity = {
            "critical": 0,
            "high": 0,
            "medium": 0,
            "low": 0
        }

        for v in vulnerabilities:
            key = v.severity.value
            if key in by_severity:
                by_severity[key] += 1

        summary_parts = []
        if by_severity["critical"] > 0:
            summary_parts.append(f"{by_severity['critical']} critical")
        if by_severity["high"] > 0:
            summary_parts.append(f"{by_severity['high']} high")
        if by_severity["medium"] > 0:
            summary_parts.append(f"{by_severity['medium']} medium")
        if by_severity["low"] > 0:
            summary_parts.append(f"{by_severity['low']} low")

        summary = f"Found {len(vulnerabilities)} vulnerabilities: {', '.join(summary_parts)}. "
        
        if score >= 80:
            summary += "Security score is good but some issues should be addressed."
        elif score >= 50:
            summary += "Security score is moderate. Several issues need attention."
        else:
            summary += "Security score is poor. Critical issues must be fixed immediately."

        return summary

    def _empty_result(self) -> dict:
        """Return empty result structure"""
        return {
            "vulnerabilities": [],
            "summary": "No code provided for analysis.",
            "score": 100,
            "total_vulnerabilities": 0,
            "language": "unknown"
        }


def create_scanner() -> VulnerabilityScanner:
    """Factory function to create scanner instance"""
    return VulnerabilityScanner()
