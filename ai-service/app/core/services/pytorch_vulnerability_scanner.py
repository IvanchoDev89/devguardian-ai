"""
Pattern-based Vulnerability Scanner
Works without PyTorch - uses regex pattern matching
"""

from typing import List, Dict, Any, Optional
from enum import Enum
import re
from dataclasses import dataclass


class VulnerabilityType(Enum):
    SQL_INJECTION = "sql_injection"
    XSS = "xss"
    PATH_TRAVERSAL = "path_traversal"
    COMMAND_INJECTION = "command_injection"
    INSECURE_DESERIALIZATION = "insecure_deserialization"
    WEAK_CRYPTOGRAPHY = "weak_cryptography"
    HARDCODED_CREDENTIALS = "hardcoded_credentials"
    BROKEN_AUTHENTICATION = "broken_authentication"


class SeverityLevel(Enum):
    CRITICAL = "critical"
    HIGH = "high"
    MEDIUM = "medium"
    LOW = "low"


@dataclass
class VulnerabilityResult:
    vulnerability_type: str
    severity: str
    cwe_id: str
    description: str
    line_number: int
    code_snippet: str
    confidence: float


class PyTorchVulnerabilityScanner:
    """Pattern-based vulnerability scanner"""
    
    def __init__(self):
        self.vulnerability_patterns = {
            'sql_injection': {
                'patterns': [
                    (r'execute\s*\(\s*["\'].*?\$', SeverityLevel.CRITICAL, 'CWE-89'),
                    (r'query\s*\(\s*["\'].*?\$', SeverityLevel.HIGH, 'CWE-89'),
                    (r'SELECT.*?FROM.*?WHERE.*?\$', SeverityLevel.HIGH, 'CWE-89'),
                    (r'UNION\s+SELECT', SeverityLevel.HIGH, 'CWE-89'),
                    (r'"\s*\.\s*"\s*\.\s*\$', SeverityLevel.HIGH, 'CWE-89'),
                ],
                'description': 'SQL Injection vulnerability'
            },
            'xss': {
                'patterns': [
                    (r'innerHTML\s*=', SeverityLevel.HIGH, 'CWE-79'),
                    (r'document\.write\s*\(', SeverityLevel.MEDIUM, 'CWE-79'),
                    (r'eval\s*\(', SeverityLevel.CRITICAL, 'CWE-79'),
                    (r'<script>.*?</script>', SeverityLevel.HIGH, 'CWE-79'),
                ],
                'description': 'Cross-Site Scripting vulnerability'
            },
            'command_injection': {
                'patterns': [
                    (r'exec\s*\(', SeverityLevel.CRITICAL, 'CWE-78'),
                    (r'system\s*\(', SeverityLevel.CRITICAL, 'CWE-78'),
                    (r'shell_exec\s*\(', SeverityLevel.CRITICAL, 'CWE-78'),
                    (r'passthru\s*\(', SeverityLevel.CRITICAL, 'CWE-78'),
                    (r'`.*?\$.*?`', SeverityLevel.CRITICAL, 'CWE-78'),
                ],
                'description': 'Command Injection vulnerability'
            },
            'path_traversal': {
                'patterns': [
                    (r'\.\.\/', SeverityLevel.HIGH, 'CWE-22'),
                    (r'\.\.\/\\', SeverityLevel.HIGH, 'CWE-22'),
                    (r'file_get_contents\s*\(\s*\$', SeverityLevel.MEDIUM, 'CWE-22'),
                    (r'file_put_contents\s*\(\s*\$', SeverityLevel.MEDIUM, 'CWE-22'),
                ],
                'description': 'Path Traversal vulnerability'
            },
            'hardcoded_credentials': {
                'patterns': [
                    (r'password\s*=\s*["\'][^"\']{6,}["\']', SeverityLevel.HIGH, 'CWE-798'),
                    (r'api[_-]?key\s*=\s*["\'][a-zA-Z0-9]{20,}["\']', SeverityLevel.HIGH, 'CWE-798'),
                    (r'secret[_-]?key\s*=\s*["\'][^"\']{16,}["\']', SeverityLevel.HIGH, 'CWE-798'),
                    (r'token\s*=\s*["\'][a-zA-Z0-9_-]{20,}["\']', SeverityLevel.MEDIUM, 'CWE-798'),
                ],
                'description': 'Hardcoded Credentials'
            },
            'weak_cryptography': {
                'patterns': [
                    (r'md5\s*\(', SeverityLevel.MEDIUM, 'CWE-327'),
                    (r'sha1\s*\(', SeverityLevel.MEDIUM, 'CWE-327'),
                    (r'DES\.new\s*\(', SeverityLevel.HIGH, 'CWE-327'),
                    (r'MD5\.new\s*\(', SeverityLevel.MEDIUM, 'CWE-327'),
                ],
                'description': 'Weak Cryptographic Algorithm'
            },
            'insecure_deserialization': {
                'patterns': [
                    (r'unserialize\s*\(', SeverityLevel.CRITICAL, 'CWE-502'),
                    (r'pickle\.loads\s*\(', SeverityLevel.CRITICAL, 'CWE-502'),
                    (r'yaml\.load\s*\(', SeverityLevel.CRITICAL, 'CWE-502'),
                    (r'yaml\.unsafe_load\s*\(', SeverityLevel.CRITICAL, 'CWE-502'),
                ],
                'description': 'Insecure Deserialization'
            },
        }
    
    def scan_code(self, code: str, language: str = 'php') -> List[VulnerabilityResult]:
        """Scan code for vulnerabilities"""
        results = []
        lines = code.split('\n')
        
        for vuln_type, vuln_data in self.vulnerability_patterns.items():
            for pattern, severity, cwe in vuln_data['patterns']:
                for line_num, line in enumerate(lines, 1):
                    if re.search(pattern, line, re.IGNORECASE):
                        results.append(VulnerabilityResult(
                            vulnerability_type=vuln_type,
                            severity=severity.value,
                            cwe_id=cwe,
                            description=vuln_data['description'],
                            line_number=line_num,
                            code_snippet=line.strip(),
                            confidence=85.0
                        ))
        
        return results
    
    def scan_file(self, file_path: str) -> Dict[str, Any]:
        """Scan a file for vulnerabilities"""
        try:
            with open(file_path, 'r', encoding='utf-8', errors='ignore') as f:
                code = f.read()
            
            vulnerabilities = self.scan_code(code)
            
            return {
                'file_path': file_path,
                'vulnerabilities_found': len(vulnerabilities),
                'vulnerabilities': [v.__dict__ for v in vulnerabilities],
                'scan_status': 'completed'
            }
        except Exception as e:
            return {
                'file_path': file_path,
                'error': str(e),
                'scan_status': 'failed'
            }
